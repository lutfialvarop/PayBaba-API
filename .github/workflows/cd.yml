name: CD - Build & Deploy to Swarm

on:
    push:
        branches:
            - main

env:
    REGISTRY: docker.io
    # Format Image: username/repo
    IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/paybaba-api
    SWARM_MASTER_HOST: ${{ secrets.SWARM_MASTER_HOST }}
    SWARM_MASTER_USER: ${{ secrets.SWARM_MASTER_USER }}
    APP_DOMAIN: "apipaybaba.lutfialvarop.com"

jobs:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 1. BUILD & PUSH DOCKER IMAGE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    build:
        name: Build Docker Image
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write

        outputs:
            image_tag: ${{ steps.meta.outputs.tags }}

        steps:
            - uses: actions/checkout@v4
            - uses: docker/setup-buildx-action@v3

            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Extract Metadata (Tags)
              id: meta
              uses: docker/metadata-action@v5
              with:
                  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                  tags: |
                      type=raw,value=latest
                      type=sha,format=long

            - name: Build and Push
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: ${{ steps.meta.outputs.tags }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 2. DEPLOY TO SWARM
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    deploy:
        name: Update Swarm Service
        needs: build # Wajib nunggu build selesai
        runs-on: ubuntu-latest

        steps:
            - name: Setup SSH key
              run: |
                  mkdir -p ~/.ssh

                  # 1. Decode Base64 ke file (Menggunakan printf agar lebih aman)
                  printf "%s" "${{ secrets.SWARM_MASTER_SSH_KEY }}" | base64 -d > ~/.ssh/swarm_key

                  # 2. [PENTING] Tambahkan baris baru di akhir file (Obat error libcrypto)
                  echo "" >> ~/.ssh/swarm_key

                  # 3. Atur permission (Wajib 600)
                  chmod 600 ~/.ssh/swarm_key

                  # 4. Validasi (Cek apakah depannya benar format Key, tanpa menampilkan isinya)
                  if head -n 1 ~/.ssh/swarm_key | grep -q "BEGIN"; then
                    echo "âœ… SSH Key format looks correct (Header found)."
                  else
                    echo "âŒ Error: Decoded key does not look like a valid PEM key."
                    exit 1
                  fi

                  # 5. Scan host
                  ssh-keyscan -H ${{ env.SWARM_MASTER_HOST }} >> ~/.ssh/known_hosts

            - name: Execute Remote Deployment
              run: |
                  ssh -i ~/.ssh/swarm_key ${{ env.SWARM_MASTER_USER }}@${{ env.SWARM_MASTER_HOST }} << 'EOF'
                  set -e

                  # === CONFIGURATION ===
                  SERVICE_NAME="paybaba-api"
                  # Kita pakai tag spesifik SHA commit agar pasti versi terbaru yang terdeploy
                  IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
                  DOMAIN="${{ env.APP_DOMAIN }}"

                  echo "ðŸš€ Starting Deployment for $SERVICE_NAME"

                  # Login Docker di Server (Penting untuk Private Repo)
                  echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

                  # Logic Create/Update Service
                  if docker service ls --format '{{.Name}}' | grep -q "^$SERVICE_NAME$"; then
                    echo "â™»ï¸  Updating existing service..."
                    docker service update \
                      --image $IMAGE \
                      --with-registry-auth \
                      --env-add NODE_ENV=production \
                      --env-add BASE_URL=${{ secrets.BASE_URL }} \
                      --env-add FRONTEND_URL=${{ secrets.FRONTEND_URL }} \
                      --env-add DB_HOST=my-postgres \
                      --env-add DB_PORT=5432 \
                      --env-add DB_NAME=${{ secrets.DB_NAME }} \
                      --env-add DB_USER=${{ secrets.DB_USER }} \
                      --env-add DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
                      --env-add JWT_ACCESS_TOKEN_SECRET=${{ secrets.JWT_ACCESS_TOKEN_SECRET }} \
                      --env-add JWT_REFRESH_TOKEN_SECRET=${{ secrets.JWT_REFRESH_TOKEN_SECRET }} \
                      --env-add JWT_ACCESS_TOKEN_EXPIRY=${{ secrets.JWT_ACCESS_TOKEN_EXPIRY }} \
                      --env-add JWT_REFRESH_TOKEN_EXPIRY=${{ secrets.JWT_REFRESH_TOKEN_EXPIRY }} \
                      --env-add QWEN_API_KEY=${{ secrets.QWEN_API_KEY }} \
                      --env-add MID=${{ secrets.MID }} \
                      --env-add PRIVATE_KEY=${{ secrets.PRIVATE_KEY }} \
                      --env-add PUBLIC_KEY=${{ secrets.PUBLIC_KEY }} \
                      --env-add PAYLABS_SERVER=${{ secrets.PAYLABS_SERVER }} \
                      --env-add NOTIFY_URL=${{ secrets.NOTIFY_URL }} \
                      $SERVICE_NAME
                  else
                    echo "âœ¨ Creating new service..."
                    docker service create \
                      --name $SERVICE_NAME \
                      --replicas 2 \
                      --network app-network \
                      --with-registry-auth \
                      --constraint "node.labels.role != database" \
                      --label "traefik.enable=true" \
                      --label "traefik.http.routers.paybaba.rule=Host(\`$DOMAIN\`)" \
                      --label "traefik.http.routers.paybaba.entrypoints=websecure" \
                      --label "traefik.http.routers.paybaba.tls.certresolver=myresolver" \
                      --label "traefik.http.services.paybaba.loadbalancer.server.port=3000" \
                      --env NODE_ENV=production \
                      --env BASE_URL=${{ secrets.BASE_URL }} \
                      --env FRONTEND_URL=${{ secrets.FRONTEND_URL }} \
                      --env DB_HOST=my-postgres \
                      --env DB_PORT=5432 \
                      --env DB_NAME=${{ secrets.DB_NAME }} \
                      --env DB_USER=${{ secrets.DB_USER }} \
                      --env DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
                      --env JWT_ACCESS_TOKEN_SECRET=${{ secrets.JWT_ACCESS_TOKEN_SECRET }} \
                      --env JWT_REFRESH_TOKEN_SECRET=${{ secrets.JWT_REFRESH_TOKEN_SECRET }} \
                      --env JWT_ACCESS_TOKEN_EXPIRY=${{ secrets.JWT_ACCESS_TOKEN_EXPIRY }} \
                      --env JWT_REFRESH_TOKEN_EXPIRY=${{ secrets.JWT_REFRESH_TOKEN_EXPIRY }} \
                      --env QWEN_API_KEY=${{ secrets.QWEN_API_KEY }} \
                      --env MID=${{ secrets.MID }} \
                      --env PRIVATE_KEY=${{ secrets.PRIVATE_KEY }} \
                      --env PUBLIC_KEY=${{ secrets.PUBLIC_KEY }} \
                      --env PAYLABS_SERVER=${{ secrets.PAYLABS_SERVER }} \
                      --env NOTIFY_URL=${{ secrets.NOTIFY_URL }} \
                      $IMAGE
                  fi

                  # Force update service untuk menarik image terbaru jika pakai tag :latest
                  docker service update --force $SERVICE_NAME

                  echo "âœ… Deployment command sent. Waiting for stability..."
                  sleep 10
                  docker service ps $SERVICE_NAME --no-trunc
                  EOF

            - name: Cleanup Key
              if: always()
              run: rm -f ~/.ssh/swarm_key

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # 3. HEALTH CHECK
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    health-check:
        name: Verify Production Health
        needs: deploy
        runs-on: ubuntu-latest
        steps:
            - name: Check URL
              run: |
                  echo "Waiting for Traefik routing..."
                  for i in {1..10}; do
                    # -k untuk bypass SSL check (jika baru renew)
                    STATUS=$(curl -k -s -o /dev/null -w "%{http_code}" https://${{ env.APP_DOMAIN }}/health)
                    if [ "$STATUS" == "200" ]; then
                      echo "âœ… Health check PASSED (200 OK)"
                      exit 0
                    fi
                    echo "Attempt $i: Got status $STATUS. Retrying..."
                    sleep 10
                  done
                  echo "âŒ Health check FAILED"
                  exit 1
